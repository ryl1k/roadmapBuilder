{% extends "base.html" %}

{% block title %}AI Chat - Course Recommendation Platform{% endblock %}

{% block content %}
<div class="max-w-5xl mx-auto mt-10 fade-in" x-data="chatData()" x-init="init()">
    <div class="bg-gray-800/50 backdrop-blur rounded-2xl border border-gray-700 overflow-hidden">
        <!-- Chat Header -->
        <div class="bg-gradient-to-r from-purple-600 to-pink-600 p-6">
            <h2 class="text-2xl font-bold">AI Learning Assistant</h2>
            <p class="text-purple-100 text-sm mt-1">Describe your learning goals and I'll create a personalized roadmap</p>
        </div>

        <!-- Chat Messages -->
        <div class="h-[500px] overflow-y-auto p-6 space-y-4" id="chat-container">
            <!-- Initial AI Message -->
            <div class="flex gap-3">
                <div class="flex-shrink-0">
                    <div class="w-10 h-10 bg-gradient-to-br from-purple-600 to-pink-600 rounded-full flex items-center justify-center">
                        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                        </svg>
                    </div>
                </div>
                <div class="flex-1">
                    <div class="bg-gray-700/50 rounded-xl p-4 max-w-2xl">
                        <p class="text-gray-200">
                            Hello! I'm your AI learning assistant. Tell me about your learning goals in your own words.
                        </p>
                        <p class="text-gray-400 text-sm mt-2">
                            For example: "I want to become a data scientist. I know some Python basics but I'm new to machine learning..."
                        </p>
                    </div>
                </div>
            </div>

            <!-- Dynamic Messages -->
            <template x-for="(msg, index) in messages" :key="index">
                <div :class="msg.role === 'user' ? 'flex justify-end' : 'flex gap-3'">
                    <!-- AI Avatar -->
                    <template x-if="msg.role === 'assistant'">
                        <div class="flex-shrink-0">
                            <div class="w-10 h-10 bg-gradient-to-br from-purple-600 to-pink-600 rounded-full flex items-center justify-center">
                                <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                                </svg>
                            </div>
                        </div>
                    </template>

                    <!-- Message Bubble -->
                    <div :class="msg.role === 'user' ? 'bg-gradient-to-r from-purple-600 to-pink-600 rounded-xl p-4 max-w-2xl' : 'bg-gray-700/50 rounded-xl p-4 max-w-2xl'">
                        <div x-html="msg.content"></div>
                    </div>
                </div>
            </template>

            <!-- Loading Indicator -->
            <template x-if="loading">
                <div class="flex gap-3">
                    <div class="w-10 h-10 bg-gradient-to-br from-purple-600 to-pink-600 rounded-full flex items-center justify-center">
                        <svg class="w-5 h-5 text-white animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                        </svg>
                    </div>
                    <div class="bg-gray-700/50 rounded-xl p-4">
                        <div class="flex space-x-2">
                            <div class="w-2 h-2 bg-purple-500 rounded-full animate-bounce" style="animation-delay: 0ms"></div>
                            <div class="w-2 h-2 bg-purple-500 rounded-full animate-bounce" style="animation-delay: 150ms"></div>
                            <div class="w-2 h-2 bg-purple-500 rounded-full animate-bounce" style="animation-delay: 300ms"></div>
                        </div>
                    </div>
                </div>
            </template>
        </div>

        <!-- Input Area -->
        <div class="border-t border-gray-700 p-4">
            <form @submit.prevent="sendMessage" class="flex gap-3">
                <input
                    type="text"
                    x-model="userInput"
                    :disabled="loading"
                    placeholder="Describe your learning goals..."
                    class="flex-1 px-4 py-3 bg-gray-900 border border-gray-700 rounded-lg focus:border-purple-500 focus:ring-2 focus:ring-purple-500/50 outline-none transition disabled:opacity-50"
                >
                <button
                    type="submit"
                    :disabled="loading || !userInput.trim()"
                    class="px-6 py-3 bg-gradient-to-r from-purple-600 to-pink-600 rounded-lg font-semibold hover:shadow-lg hover:shadow-purple-500/50 transition disabled:opacity-50 disabled:cursor-not-allowed">
                    Send
                </button>
            </form>
        </div>
    </div>
</div>

<script>
function chatData() {
    return {
        messages: [],
        userInput: '',
        loading: false,
        courses: [],
        availableTags: [],

        async init() {
            // Load courses and tags for reference
            try {
                const [coursesRes, tagsRes] = await Promise.all([
                    fetch('{{ backend_url }}/courses'),
                    fetch('{{ backend_url }}/tags')
                ]);
                this.courses = await coursesRes.json();
                this.availableTags = await tagsRes.json();
            } catch (err) {
                console.error('Failed to load courses/tags:', err);
            }
        },

        async sendMessage() {
            if (!this.userInput.trim() || this.loading) return;

            const userMessage = this.userInput.trim();
            this.userInput = '';

            // Add user message
            this.messages.push({
                role: 'user',
                content: userMessage
            });

            this.scrollToBottom();
            this.loading = true;

            try {
                // Call AI service to extract tags (send available tags to constrain AI)
                const aiResponse = await fetch('{{ ai_url }}/api/extract-tags', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        description: userMessage,
                        availableTags: this.availableTags
                    })
                });

                if (!aiResponse.ok) throw new Error('AI service failed');

                const aiData = await aiResponse.json();
                const { tags, targetDomain, currentLevel, hoursPerWeek, deadlineWeeks } = aiData;

                // Add AI thinking message
                this.messages.push({
                    role: 'assistant',
                    content: `<p class="text-gray-200">Great! I've analyzed your goals. Here's what I found:</p>
                             <ul class="mt-2 space-y-1 text-sm text-gray-300">
                                <li><strong>Domain:</strong> ${targetDomain}</li>
                                <li><strong>Level:</strong> ${currentLevel}</li>
                                <li><strong>Key Topics:</strong> ${tags.join(', ')}</li>
                             </ul>
                             <p class="mt-3 text-gray-400 text-sm">Generating your personalized roadmap...</p>`
                });

                this.scrollToBottom();

                // Call backend greedy algorithm
                const profile = {
                    userId: 1,
                    targetDomain,
                    currentLevel,
                    interests: tags,
                    hoursPerWeek: hoursPerWeek || 10,
                    deadlineWeeks: deadlineWeeks || 12
                };

                const planResponse = await fetch('{{ backend_url }}/recommendations', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ profile })
                });

                if (!planResponse.ok) throw new Error('Failed to generate plan');

                const plan = await planResponse.json();

                // Enrich with course details
                const coursesDict = {};
                this.courses.forEach(c => coursesDict[c.id] = c);

                plan.steps.forEach(step => {
                    const course = coursesDict[step.courseId];
                    if (course) {
                        step.courseTitle = course.title;
                        step.courseDomain = course.domain;
                        step.courseLevel = course.level;
                    }
                });

                // Display plan
                let planHtml = `<p class="font-semibold text-lg mb-3">Your Learning Roadmap (${plan.totalHours} hours)</p>`;
                planHtml += '<div class="space-y-3">';

                plan.steps.forEach((step, idx) => {
                    planHtml += `
                        <div class="bg-gray-800/50 rounded-lg p-3 border border-gray-600">
                            <div class="flex items-start gap-3">
                                <div class="w-8 h-8 bg-purple-600 rounded-full flex items-center justify-center font-bold text-sm flex-shrink-0">
                                    ${step.step}
                                </div>
                                <div class="flex-1 min-w-0">
                                    <div class="font-semibold">${step.courseTitle || 'Course #' + step.courseId}</div>
                                    <div class="text-xs text-gray-400 mt-1">
                                        <span class="inline-block px-2 py-1 bg-purple-600/30 rounded">${step.courseLevel || ''}</span>
                                        <span class="ml-2">${step.hours} hours</span>
                                    </div>
                                    ${step.note ? '<div class="text-sm text-gray-400 mt-1">' + step.note + '</div>' : ''}
                                </div>
                            </div>
                        </div>
                    `;
                });

                planHtml += '</div>';
                planHtml += `<div class="mt-4 pt-4 border-t border-gray-600">
                                <p class="text-sm text-gray-400">Need modifications? Just describe what you'd like to change!</p>
                             </div>`;

                this.messages.push({
                    role: 'assistant',
                    content: planHtml
                });

            } catch (err) {
                this.messages.push({
                    role: 'assistant',
                    content: `<p class="text-red-400">Sorry, I encountered an error: ${err.message}</p>
                             <p class="text-sm text-gray-400 mt-2">Please try describing your goals again.</p>`
                });
            } finally {
                this.loading = false;
                this.scrollToBottom();
            }
        },

        scrollToBottom() {
            this.$nextTick(() => {
                const container = document.getElementById('chat-container');
                container.scrollTop = container.scrollHeight;
            });
        }
    }
}
</script>
{% endblock %}
